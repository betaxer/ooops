

首先，该算法有如下假设：

1. 网络是合理配置的（例如：没有循环拓扑）
2. switch上的所有的MIB表都是最新的（eg:算法执行过程中没有正在变化的拓扑）
3. 交换机支持Spanning Tree Algorithm

主要有三步：

1. 找出所有的交换机和路由器
2. 从交换机上找出和Spanning Tree有关的所有MIB表
3. 从路由地址转译(Router Address Translation)信息中收集MIB表

由于交换机的连接是树形结构，通过遍历所有的交换机组合我们很容易的找到两个交换机之间连接的接口。

## 数据收集阶段

**找出交换机和路由器**：这里我们不关注如何发现所有的设备。假设设备集合已经有了，我们可以通过一些启发式的方式判断一个设备是否是交换机或者路由器，根据系统OID或者各种MIB的值（比如：*system.sysServices, ip.ipForwards, dot1d.baseType*)。这里一个需要注意的是广播地址或者网关地址需要被过滤掉。而且，有些设备可能对应多个不同的IP。

采集交换机的MIB表：Bridge-MIB包含了一些能够描述Spanning Tree算法的对象。参见下表。

采集路由器的MIB表：路由其中的ip.ipNetToMedia MIB表中保存了物理地址到IP地址的映射。

|                MIB Object                | OID                 | 描述                       |
| :--------------------------------------: | ------------------- | ------------------------ |
| *dot1dBridge.dot1dBase.dot1dBaseBridgeAddress* | 1.3.6.1.2.1.17.1.1  | Bridge ID                |
| *dot1dBridge.dot1dBase.dot1dStpPortTable* | 1.3.6.1.2.1.17.2.15 | Spanning Tree算法对应的表      |
| *dot1dBridge.dot1dBase.dot1dBasePortTable* | 1.3.6.1.2.1.17.1.4  | Bridge Port到ifIndex的映射   |
|  *dot1dBridge.dot1dTp.dot1dTpFdbTable*   | 1.3.6.1.2.1.17.4.3  | 转发表                      |
|            interfaces.ifTable            | 1.3.6.1.2.1.2.2     | MIB-II 接口表（每个接口的描述和统计信息） |

## 直接连接分析

对于dot1dStpPortTable中的每个节点，如果该节点的DesignatedBridge和他本身的Bridge ID不同，那么该switch和DedignatedBridge标志的交换机之间存在一条直接的连接。如果该连接的状态是*forwarding*，该连接在spanning tree上。该节点中包含了当前交换机的端口和所连接的交换机的端口。因此使用该节点可以完整的描述一个连接。

在检测连接的过程中，我们先找出dot1dStpPortTable中所有Dedignated Bridge和交换机自身Bridge ID不同的所有节点，且这些节点的状态是forwarding(5)。StpPort表示出口端口，DesignatedBridge表示相邻的机器（为了进一步的分析，我们需要把他转换成IP）。DesignatedPort表示相邻机器上的交换机端口（交换机端口需要转换成ifIndex）。

相邻交换机的IP地址可以通过BridgeID来判断。

1. 如果BridgeAddress和任意交换机的dot1dBridge.dot1dbase.dot1dBaseBridgeAddress对象匹配，那么该交换机就是这里的相邻交换机。
2. 如果相邻交换机没有使用bridge address MIB对象，还有种方法是从交换机的网卡表中找出bridge address，
3. 或者扫描改及换季的转发表找到某个节点和Bridge Address匹配，且dot1dTpFdbStatus列是自己。
4. 还有一个方法是检查路由器的ip.ipNetToMedia表，来把BridgeAddres翻译成IP地址。实践中，至少一种方法可以成功。

虽然大多数关于interface的MIB使用ifIndex对象来标记网口，但是Bridge MIB使用bridge port ID（layer 2消息中使用）。将bridge port 转换成ifIndex只需要查相邻交换机的dot1dBridge.dot1dBase.dot1dbasePortTable。但是，该表中使用证书表示，但是dot1dStpdPortTable中使用'OCTET STRING'数据格式。不同厂商的实现不同，导致这种转换变得很复杂。更可靠的方式是利用dot1dStpdPortTable构建bridge port到ifindex的转换

| stpPort | state | DesignatedRoot          | DesignatedBridge        | DesignatedPort |
| ------- | ----- | ----------------------- | ----------------------- | -------------- |
|         |       | 00:25:b4:e5:50:00       |                         |                |
| 47      | 5     | 80:01:00:25:b4:e5:50:00 | 80:01:00:25:b4:e5:50:00 | 80:2f          |
| 48      | 5     | 80:01:00:25:b4:e5:50:00 | 80:01:00:25:b4:e5:50:00 | 80:30          |
|         |       | 2c:36:f8:82:aa:00       |                         |                |
| 47      | 5     | 80:01:2c:36:f8:82:aa:00 | 80:01:2c:36:f8:82:aa:00 | 80:2f          |
| 48      | 5     | 80:01:2c:36:f8:82:aa:00 | 80:01:2c:36:f8:82:aa:00 | 80:30          |
|         |       | 00:17:95:cc:94:00       |                         |                |
| 49      | 5     | 80:01:00:17:95:cc:94:00 | 80:01:00:17:95:cc:94:00 | 80:31          |
| 50      | 5     | 80:01:00:17:95:cc:94:00 | 80:01:00:17:95:cc:94:00 | 80:32          |
|         |       | 2c:36:f8:19:86:80       |                         |                |
| 47      | 5     | 80:01:2c:36:f8:19:86:80 | 80:01:2c:36:f8:19:86:80 | 80:2f          |
| 48      | 5     | 80:01:2c:36:f8:19:86:80 | 80:01:2c:36:f8:19:86:80 | 80:30          |
|         |       | 50:17:ff:c1:88:00       |                         |                |
| 49      | 5     | 80:01:50:17:ff:c1:88:00 | 80:01:50:17:ff:c1:88:00 | 80:31          |
| 51      | 5     | 80:01:50:17:ff:c1:88:00 | 80:01:50:17:ff:c1:88:00 | 80:33          |
|         |       | 00:1e:49:1f:1f:00       |                         |                |
| 47      | 5     | 80:01:00:1e:49:1f:1f:00 | 80:01:00:1e:49:1f:1f:00 | 80:2f          |
| 48      | 5     | 80:01:00:1e:49:1f:1f:00 | 80:01:00:1e:49:1f:1f:00 | 80:30          |
|         |       | 2c:36:f8:14:e5:00       |                         |                |
| 47      | 5     | 80:01:2c:36:f8:14:e5:00 | 80:01:2c:36:f8:14:e5:00 | 80:2f          |
| 48      | 5     | 80:01:2c:36:f8:14:e5:00 | 80:01:2c:36:f8:14:e5:00 | 80:30          |
|         |       | f8:7b:20:6c:ae:80       |                         |                |
| 2027    | 5     | 10:01:f8:7b:20:6d:73:80 | 10:01:f8:7b:20:6d:73:80 | 87:eb          |
|         |       | 00:e1:6d:04:d9:00       |                         |                |
| 47      | 5     | 80:01:00:e1:6d:04:d9:00 | 80:01:00:e1:6d:04:d9:00 | 80:2f          |
| 48      | 5     | 80:01:00:e1:6d:04:d9:00 | 80:01:00:e1:6d:04:d9:00 | 80:30          |
|         |       | 44:2b:03:1f:71:00       |                         |                |
| 47      | 5     | 60:01:44:2b:03:1f:71:00 | 60:01:44:2b:03:1f:71:00 | 80:2f          |
| 48      | 5     | 60:01:44:2b:03:1f:71:00 | 60:01:44:2b:03:1f:71:00 | 80:30          |
|         |       | f8:7b:20:6d:73:80       |                         |                |
| 2027    | 5     | 10:01:f8:7b:20:6d:73:80 | 10:01:f8:7b:20:6d:73:80 | 87:eb          |







| ---------- | :-------------: | :-------------:         | :-------------:         | :-------------: |
| ---------- | --------------- | ----------------------- | ----------------------- | --------------- |
|            | 10.12.4.23      | 00:25:b4:e5:50:00       |                         |                 |
| 47         | 5               | 80:01:00:25:b4:e5:50:00 | 80:01:00:25:b4:e5:50:00 | 80:2f           |
| 48         | 5               | 80:01:00:25:b4:e5:50:00 | 80:01:00:25:b4:e5:50:00 | 80:30           |
|            | 10.12.4.12      | 2c:36:f8:82:aa:00       |                         |                 |
| 47         | 5               | 80:01:2c:36:f8:82:aa:00 | 80:01:2c:36:f8:82:aa:00 | 80:2f           |
| 48         | 5               | 80:01:2c:36:f8:82:aa:00 | 80:01:2c:36:f8:82:aa:00 | 80:30           |
|            | 10.12.4.22      | 00:17:95:cc:94:00       |                         |                 |
| 49         | 5               | 80:01:00:17:95:cc:94:00 | 80:01:00:17:95:cc:94:00 | 80:31           |
| 50         | 5               | 80:01:00:17:95:cc:94:00 | 80:01:00:17:95:cc:94:00 | 80:32           |
|            | 10.12.4.11      | 2c:36:f8:19:86:80       |                         |                 |
| 47         | 5               | 80:01:2c:36:f8:19:86:80 | 80:01:2c:36:f8:19:86:80 | 80:2f           |
| 48         | 5               | 80:01:2c:36:f8:19:86:80 | 80:01:2c:36:f8:19:86:80 | 80:30           |
|            | 10.12.4.14      | 50:17:ff:c1:88:00       |                         |                 |
| 49         | 5               | 80:01:50:17:ff:c1:88:00 | 80:01:50:17:ff:c1:88:00 | 80:31           |
| 51         | 5               | 80:01:50:17:ff:c1:88:00 | 80:01:50:17:ff:c1:88:00 | 80:33           |
|            | 10.12.4.24      | 00:1e:49:1f:1f:00       |                         |                 |
| 47         | 5               | 80:01:00:1e:49:1f:1f:00 | 80:01:00:1e:49:1f:1f:00 | 80:2f           |
| 48         | 5               | 80:01:00:1e:49:1f:1f:00 | 80:01:00:1e:49:1f:1f:00 | 80:30           |
|            | 10.12.4.13      | 2c:36:f8:14:e5:00       |                         |                 |
| 47         | 5               | 80:01:2c:36:f8:14:e5:00 | 80:01:2c:36:f8:14:e5:00 | 80:2f           |
| 48         | 5               | 80:01:2c:36:f8:14:e5:00 | 80:01:2c:36:f8:14:e5:00 | 80:30           |
|            | 10.12.240.17    | f8:7b:20:6c:ae:80       |                         |                 |
| 2027       | 5               | 10:01:f8:7b:20:6d:73:80 | 10:01:f8:7b:20:6d:73:80 | 87:eb           |
|            | 10.12.4.21      | 00:e1:6d:04:d9:00       |                         |                 |
| 47         | 5               | 80:01:00:e1:6d:04:d9:00 | 80:01:00:e1:6d:04:d9:00 | 80:2f           |
| 48         | 5               | 80:01:00:e1:6d:04:d9:00 | 80:01:00:e1:6d:04:d9:00 | 80:30           |
|            | 10.12.4.3       | 44:2b:03:1f:71:00       |                         |                 |
| 47         | 5               | 60:01:44:2b:03:1f:71:00 | 60:01:44:2b:03:1f:71:00 | 80:2f           |
| 48         | 5               | 60:01:44:2b:03:1f:71:00 | 60:01:44:2b:03:1f:71:00 | 80:30           |
|            | 10.12.240.16    | f8:7b:20:6d:73:80       |                         |                 |
| 2027       | 5               | 10:01:f8:7b:20:6d:73:80 | 10:01:f8:7b:20:6d:73:80 | 87:eb           |

根据上面的表，我们可以